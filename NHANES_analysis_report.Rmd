---
title: "NHANES 2021-2023: BMI and Blood Pressure Analysis"
author: ''
date: "`r Sys.Date()`"
output:
  word_document:
    toc: true
    toc_depth: '3'
  pdf_document:
    toc: true
    toc_depth: 3
    latex_engine: xelatex
---

```{r setup, include=TRUE}
# Introduction & Setup
# Purpose: Observe association between BMI and mean SBP among adults >=20 in NHANES 2021-2023 and whether association varies by sex.
# Also explore BMI distribution by education & race, and BP trial variability.

# Reproducibility notes: edit `data_dir` to point to local folder with NHANES XPT files
data_dir <- "C:/Users/Edison/Downloads/健康大數據分析作業資料"

pkgs <- c("tidyverse","haven","janitor","stringr","scales","skimr","naniar","broom","ggpubr","knitr")
new_pkgs <- setdiff(pkgs, installed.packages()[,"Package"]) 
if(length(new_pkgs)) install.packages(new_pkgs, repos = "https://cloud.r-project.org")

lapply(pkgs, library, character.only = TRUE)
options(dplyr.summarise.inform = FALSE)

# Create outputs folder
if(!dir.exists("outputs")) dir.create("outputs")

# Helper: safe read XPT
safe_read_xpt <- function(path){
  if(file.exists(path)) read_xpt(path) %>% clean_names() else stop(paste0("File not found: ", path))
}

# Check for LaTeX engine (TinyTeX) for PDF rendering
if(!requireNamespace("tinytex", quietly = TRUE)){
  message("tinytex not installed. Rendering to PDF requires a LaTeX distribution.\nInstalling tinytex package... (you may still need system LaTeX).")
  install.packages("tinytex")
}
if(!tinytex::is_tinytex()){
  message("tinytex distribution not installed. You can install it via tinytex::install_tinytex() if you want a lightweight LaTeX setup.")
}
```

## Data loading
```{r data-loading}
# Read NHANES files (edit filenames if necessary)
demo <- safe_read_xpt(file.path(data_dir, "DEMO_L.XPT"))
bmx  <- safe_read_xpt(file.path(data_dir, "BMX_L.XPT"))
bpx  <- safe_read_xpt(file.path(data_dir, "BPXO_L.XPT"))

# Quick glimpse
skimr::skim(demo)
skimr::skim(bmx)
skimr::skim(bpx)
```

## Week 5: BMI & SBP cleaning
### Build raw variables and compute mean BP
```{r week5-raw}
# Detect BP columns
sbp_cols <- names(bpx)[stringr::str_detect(names(bpx), "^bpxo?sy[1-3]$")]
dbp_cols <- names(bpx)[stringr::str_detect(names(bpx), "^bpxo?di[1-3]$")]

bpx_summary <- bpx %>%
  transmute(seqn,
            mean_sbp = rowMeans(select(., any_of(sbp_cols)), na.rm = TRUE),
            mean_dbp = rowMeans(select(., any_of(dbp_cols)), na.rm = TRUE)) %>%
  mutate(mean_sbp = ifelse(is.nan(mean_sbp), NA_real_, mean_sbp),
         mean_dbp = ifelse(is.nan(mean_dbp), NA_real_, mean_dbp))

# Prepare demographics and BMI
demo <- demo %>% mutate(riagendr = as.numeric(riagendr))
demo_sex <- demo %>% transmute(seqn, age = ridageyr, sex = factor(riagendr, levels=c(1,2), labels=c("Male","Female")))

bmi_raw <- bmx %>% transmute(seqn, bmi_raw = bmxbmi)

dat_raw <- demo_sex %>% left_join(bmi_raw, by = "seqn") %>% left_join(bpx_summary, by = "seqn") %>% filter(age >= 20)

# Save a small head to outputs for inspecting
write.csv(head(dat_raw, 50), file = "outputs/dat_raw_head.csv", row.names = FALSE)
```

### Outlier cleaning (physiologic + IQR + MAD)
```{r week5-clean}
# BMI cleaning
BMI_LO <- 10; BMI_HI <- 80
bmi_clean <- bmx %>% transmute(seqn, bmxbmi) %>% mutate(
  q1 = quantile(bmxbmi, 0.25, na.rm = TRUE),
  q3 = quantile(bmxbmi, 0.75, na.rm = TRUE),
  iqr = q3 - q1,
  lo_iqr = q1 - 1.5*iqr,
  hi_iqr = q3 + 1.5*iqr,
  med = median(bmxbmi, na.rm = TRUE),
  madv = mad(bmxbmi, na.rm = TRUE),
  z = ifelse(madv > 0, (bmxbmi - med)/madv, 0),
  flag = (bmxbmi < BMI_LO | bmxbmi > BMI_HI) | (bmxbmi < lo_iqr | bmxbmi > hi_iqr) | (abs(z) > 3.5),
  bmxbmi_clean = ifelse(flag, NA_real_, bmxbmi)
) %>% select(seqn, bmxbmi_clean)

# SBP cleaning
SBP_LO <- 70; SBP_HI <- 260
sbp_clean <- bpx_summary %>% transmute(seqn, mean_sbp) %>% mutate(
  q1 = quantile(mean_sbp, 0.25, na.rm = TRUE),
  q3 = quantile(mean_sbp, 0.75, na.rm = TRUE),
  iqr = q3 - q1,
  lo_iqr = q1 - 1.5*iqr,
  hi_iqr = q3 + 1.5*iqr,
  med = median(mean_sbp, na.rm = TRUE),
  madv = mad(mean_sbp, na.rm = TRUE),
  z = ifelse(madv > 0, (mean_sbp - med)/madv, 0),
  flag = (mean_sbp < SBP_LO | mean_sbp > SBP_HI) | (mean_sbp < lo_iqr | mean_sbp > hi_iqr) | (abs(z) > 3.5),
  mean_sbp_clean = ifelse(flag, NA_real_, mean_sbp)
) %>% select(seqn, mean_sbp_clean)

# Build cleaned analytic dataset
anal <- demo_sex %>% left_join(bmi_clean, by = "seqn") %>% left_join(sbp_clean, by = "seqn") %>% filter(age >= 20)
```

### Plots: Boxplots before vs after
```{r week5-plots, fig.height=4, fig.width=8}
# BMI before vs after
p_bmi_before <- ggplot(dat_raw, aes(x = "raw", y = bmi_raw)) + geom_boxplot() + labs(title = "BMI: raw")
p_bmi_after  <- ggplot(anal, aes(x = "clean", y = bmxbmi_clean)) + geom_boxplot() + labs(title = "BMI: cleaned")

# SBP before vs after
p_sbp_before <- ggplot(dat_raw, aes(x = "raw", y = mean_sbp)) + geom_boxplot() + labs(title = "Mean SBP: raw")
p_sbp_after  <- ggplot(anal, aes(x = "clean", y = mean_sbp_clean)) + geom_boxplot() + labs(title = "Mean SBP: cleaned")

# Arrange
ggpubr::ggarrange(p_bmi_before, p_bmi_after, p_sbp_before, p_sbp_after, ncol = 2, nrow = 2)
```

### Scatter: BMI vs SBP by sex and regression
```{r week5-scatter}
anal2 <- anal %>% mutate(sex = factor(sex)) %>% filter(!is.na(bmxbmi_clean) & !is.na(mean_sbp_clean))

p_scatter <- ggplot(anal2, aes(x = bmxbmi_clean, y = mean_sbp_clean, color = sex)) +
  geom_point(alpha = 0.6) + geom_smooth(method = "lm") + labs(title = "BMI vs Mean SBP by Sex")
print(p_scatter)

# Stratified models
models <- anal2 %>% group_by(sex) %>% nest() %>% mutate(model = map(data, ~ lm(mean_sbp_clean ~ bmxbmi_clean + age, data = .x)), tidy = map(model, broom::tidy))
models %>% unnest(tidy)
```

### Missingness before/after
```{r week5-missing}
miss_before <- tibble(variable = c("BMI","SBP"), before = c(sum(is.na(dat_raw$bmi_raw)), sum(is.na(dat_raw$mean_sbp))))
miss_after  <- tibble(variable = c("BMI","SBP"), after  = c(sum(is.na(anal$bmxbmi_clean)), sum(is.na(anal$mean_sbp_clean))))
miss_tab <- left_join(miss_before, miss_after, by = "variable") %>% mutate(total = nrow(anal), before_pct = before/total, after_pct = after/total)
knitr::kable(miss_tab)

p_miss <- miss_tab %>% pivot_longer(cols = c(before, after), names_to = "stage", values_to = "n") %>% ggplot(aes(x = variable, y = n, fill = stage)) + geom_col(position = "dodge")
print(p_miss)
```

## Week 6: EDU, Race, and BP trials
### Recode EDU and Race; distribution tables
```{r week6-edu-race}
# EDU (dmdeduc2)
dat_demo_edu <- demo %>% transmute(seqn, age = ridageyr, dmdeduc2)
edu_tab <- dat_demo_edu %>% mutate(edu = case_when(
  dmdeduc2 == 1 ~ "<9th",
  dmdeduc2 == 2 ~ "9-11th",
  dmdeduc2 == 3 ~ "HS/GED",
  dmdeduc2 == 4 ~ "Some college",
  dmdeduc2 == 5 ~ "College+",
  TRUE ~ NA_character_
)) %>% count(edu) %>% mutate(prop = n/sum(n))
knitr::kable(edu_tab)
write.csv(edu_tab, file = "outputs/EDU_distribution.csv", row.names = FALSE)

# Race (ridreth3)
race_tab <- demo %>% transmute(seqn, ridreth3) %>% mutate(ridreth3 = as.integer(ridreth3)) %>% mutate(race = case_when(ridreth3==1 ~ "Mexican", ridreth3==2 ~ "Other Hisp", ridreth3==3 ~ "NH White", ridreth3==4 ~ "NH Black", ridreth3==6 ~ "NH Asian", TRUE ~ "Other/NA")) %>% count(race) %>% mutate(prop = n/sum(n))
knitr::kable(race_tab)
write.csv(race_tab, file = "outputs/RACE_distribution.csv", row.names = FALSE)
```

### BMI distribution by EDU and Race (boxplots)
```{r week6-bmi-plots, fig.height=5, fig.width=9}
# attach cleaned BMI
bmi_for_plots <- anal %>% select(seqn, bmxbmi_clean) %>% left_join(demo %>% select(seqn, dmdeduc2, ridreth3), by = "seqn") %>% mutate(
  EDU = case_when(
    dmdeduc2 == 1 ~ "<9th",
    dmdeduc2 == 2 ~ "9-11th",
    dmdeduc2 == 3 ~ "HS/GED",
    dmdeduc2 == 4 ~ "Some college",
    dmdeduc2 == 5 ~ "College+",
    TRUE ~ NA_character_
  ),
  RACE = case_when(ridreth3==1 ~ "Mexican", ridreth3==2 ~ "Other Hisp", ridreth3==3 ~ "NH White", ridreth3==4 ~ "NH Black", ridreth3==6 ~ "NH Asian", TRUE ~ "Other/NA")
) %>%
  mutate(EDU = factor(EDU, levels = c("<9th","9-11th","HS/GED","Some college","College+"))) %>%
  drop_na(bmxbmi_clean)

p_bmi_edu  <- ggplot(bmi_for_plots, aes(x = EDU, y = bmxbmi_clean, fill = EDU)) + geom_boxplot() + labs(title = "BMI by Education") + theme_minimal()
p_bmi_race <- ggplot(bmi_for_plots, aes(x = RACE, y = bmxbmi_clean, fill = RACE)) + geom_boxplot() + labs(title = "BMI by Race") + theme_minimal() + theme(axis.text.x = element_text(angle = 25, hjust = 1))

p_bmi_edu; p_bmi_race
```

### Reshape BP trials (wide → long) and plots
```{r week6-bp-long, fig.height=5, fig.width=9}
sbp_cols <- names(bpx)[stringr::str_detect(names(bpx), "^bpxo?sy[1-3]$")]
dbp_cols <- names(bpx)[stringr::str_detect(names(bpx), "^bpxo?di[1-3]$")]

bpx_long <- bpx %>% select(seqn, any_of(c(sbp_cols, dbp_cols))) %>% pivot_longer(cols = -seqn, names_to = c("measure","trial"), names_pattern = "^bpxo?(sy|di)([1-3])$", values_to = "value") %>% mutate(measure = recode(measure, "sy" = "SBP", "di" = "DBP"), trial = as.integer(trial)) %>% filter(!is.na(value))

p_bp_trials <- ggplot(bpx_long, aes(x = factor(trial), y = value, fill = factor(trial))) + geom_boxplot() + facet_wrap(~measure, scales = "free_y") + labs(title = "BP trials")
print(p_bp_trials)

# Save
ggsave("outputs/BP_trials_boxplot_rmd.png", p_bp_trials, width = 9, height = 5)
```

### Homework extension: select two trials with largest within-subject difference
```{r week6-two-trials}
bpx_two <- bpx_long %>% group_by(seqn, measure) %>% filter(n()>=2) %>% mutate(vmin = min(value, na.rm = TRUE), vmax = max(value, na.rm = TRUE)) %>% filter(value %in% c(vmin, vmax)) %>% ungroup()

p_bp_two <- ggplot(bpx_two, aes(x = factor(trial), y = value, fill = factor(trial))) + geom_boxplot() + facet_wrap(~measure, scales = "free_y") + labs(title = "Two extreme trials per subject")
print(p_bp_two)
ggsave("outputs/BP_two_extreme_rmd.png", p_bp_two, width = 9, height = 5)

# Summary stat: mean absolute within-subject difference per measure
within_diff <- bpx_long %>% group_by(seqn, measure) %>% filter(n()>=2) %>% summarise(ma_diff = max(value, na.rm=TRUE) - min(value, na.rm=TRUE)) %>% group_by(measure) %>% summarise(mean_ma_diff = mean(ma_diff, na.rm = TRUE), median_ma_diff = median(ma_diff, na.rm = TRUE), n = n())
knitr::kable(within_diff)
```

## Conclusion
```{r conclusion, echo=FALSE}
cat("Summary of findings:\n")
cat("After data cleaning, BMI and mean SBP show a generally positive association: higher BMI tends to be associated with higher mean systolic blood pressure. Sex-stratified analyses and an interaction model are provided to examine whether the BMI–SBP slope differs by sex. BMI distributions also vary meaningfully by education level and race. Within-subject BP trial differences were summarized to assess measurement variability; consult the figures and the within-subject summary table for details.\n\n")
cat("What this taught us about reproducible workflows:\n")
cat("Keeping every step in a single RMarkdown—data loading, explicit cleaning rules, plotting, and models—makes the analysis fully reproducible. Key practices used here: parameterize file paths, list and install required packages at the top, save intermediate outputs, and use small, well-documented code chunks. For formal inference, add NHANES survey weights and include sensitivity analyses; those steps are straightforward to add because the workflow is reproducible.\n")
```
